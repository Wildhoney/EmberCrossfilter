/*! ember-crossfilter by Adam Timberlake created on 2014-05-06 */
!function(a,b){a.EmberCrossfilter=b.Mixin.create({_crossfilter:null,_deletedModels:[],allowDebugging:!1,actions:{clearAllFilters:function(){var c=(new a.Date).getTime();for(var d in this.filterMap)if(this.filterMap.hasOwnProperty(d)){var e=this.filterMap[d],f=this["_dimension%@".fmt(e.dimension.capitalize())];f.filterAll(),b.set(e,"active",!1),e.value=null,this.isBooleanFilter(e)&&(e.value=0)}this._applyContentChanges(),this.allowDebugging&&b.debug("Clearing All: %@ millisecond(s)".fmt((new a.Date).getTime()-c))},addRecord:function(a){return this._crossfilter.add([a]),this._applyContentChanges(),!0},addRecords:function(a){var b=0;if(!Array.isArray(a))return console.error("You must pass an array of records: use `addRecord` instead!"),0;for(var c=0,d=a.length;d>=c;c++)if(a.hasOwnProperty(c)){var e=a[c];this.send("addRecord",e),b++}return b},deleteRecord:function(a){return this._deletedModels.push(a),this._applyContentChanges(),!0},deleteRecords:function(a){if(!Array.isArray(a))return console.error("You must pass an array of records: use `deleteRecord` instead!"),0;for(var b=0,c=a.length;c>=b;b++)if(a.hasOwnProperty(b)){var d=a[b];this.deleteRecord(d)}return a.length},sortContent:function(c,d){var e=b.get(this,"content"),f=e.hasOwnProperty("content"),g=(new a.Date).getTime();f&&(e=b.get(e,"content")),e=this._sortedContent(e,c,d),f?b.set(this,"content.content",e):b.set(this,"content",e),b.assert("In order to sort you must have a `sort` object defined.",!!b.get(this,"sort")),b.assert("You must define `sortProperty` in your `sort` object.",!!b.get(this,"sort.sortProperty")),b.set(this,"sort.sortProperty",c),b.set(this,"sort.isAscending",d),this.notifyPropertyChange("content"),this.allowDebugging&&b.debug("Sorting: %@ millisecond(s)".fmt((new a.Date).getTime()-g))}},init:function(){this._super(),console.log(b.get(this,"content")),b.addObserver(this,"content.length",this,"_createCrossfilter"),this._createCrossfilter()},isActiveFilter:function(a,c){var d=this.filterMap[a];if(this.isBooleanFilter(d)){var e=d._mapProperties[c];return"or"===this.getBooleanType(d)?Boolean(d.value&e):-1!==$.inArray(e,d.value)}return b.get(d,"active")===!0},isBooleanFilter:function(a){return"filterOr"===a.method||"filterAnd"===a.method},getBooleanType:function(a){return"filterOr"===a.method?"or":"and"},addFilter:function(a,c){var d=this.filterMap[a];this.isBooleanFilter(d)?(d.active.pushObject(c),d.active=d.active.uniq(),"or"===this.getBooleanType(d)?d.value|=d._mapProperties[c]:(b.isArray(d.value)||(d.value=[]),d.value.push(d._mapProperties[c]))):(d.value=c,b.set(d,"active",!0)),this._updateContent(d)},removeFilter:function(a,c){var d=this.filterMap[a];if(this.isBooleanFilter(d)||(d.value=!1,b.set(d,"active",!1)),this.isBooleanFilter(d))if(d.active.removeObject(c),d.active=d.active.uniq(),"or"===this.getBooleanType(d))d.value&d._mapProperties[c]&&(d.value^=d._mapProperties[c]);else{var e=d.value.indexOf(d._mapProperties[c]);d.value.splice(e,1)}this._updateContent(d)},top:function(a,b){return this._topBottom(a,b,"top")},bottom:function(a,b){return this._topBottom(a,b,"bottom")},_topBottom:function(a,c,d){b.assert('Dimension with key "%@" is not defined.'.fmt(a),!!this.filterMap[a]);var e=this.filterMap[a],f="_dimension%@".fmt(e.dimension.capitalize());return console.log(this.get("_dimensionCuteness")),this[f][d](c||1)[0]},_createCrossfilter:function(){b.assert("Controller implements EmberCrossfilter but `filterMap` has not been specified.",!!this.filterMap);var c=b.get(this,"content"),d=c.hasOwnProperty("content");d&&(c=b.get(c,"content"));var e=!!this._crossfilter,f=!b.get(this,"content.length");if(f||e)return!1;if(b.removeObserver(this,"content.length",this,"_createCrossfilter"),this._crossfilter=a.crossfilter(c),this._createDimensions(),b.get(this,"sort.sortProperty")){var g=b.get(this,"sort.sortProperty"),h=b.get(this,"sort.isAscending");d?b.set(this,"content.content",this._sortedContent(c,g,h)):b.set(this,"content",this._sortedContent(c,g,h))}return!0},_updateContent:function(c){var d=(new a.Date).getTime(),e=this["_dimension%@".fmt(c.dimension.capitalize())];switch(c.method){case"filterOr":case"filterAnd":this._setFilterBoolean(c,e);break;case"filterRangeMin":this._setFilterRangeMin(c,e);break;case"filterRangeMax":this._setFilterRangeMax(c,e);break;case"filterFunction":this._setFilterFunction(c,e);break;default:e[c.method](c.value)}this._applyContentChanges(),this.allowDebugging&&b.debug("Filtering: %@ millisecond(s)".fmt((new a.Date).getTime()-d))},_applyContentChanges:function(){var a=b.get(this,"_dimensionDefault"),c=this._deletedModels.map(function(a){return"undefined"==typeof a?!1:a[b.get(this,"primaryKey")||"id"]}),d=function(a){return-1===$.inArray(a,c)},e=a.filterFunction(d).top(1/0);b.get(this,"sort.sortProperty")&&(e=this._sortedContent(e,b.get(this,"sort.sortProperty"),b.get(this,"sort.isAscending")));var f=b.get(this,"content").hasOwnProperty("content");f?b.set(this,"content.content",e):b.set(this,"content",e)},_createDimensions:function(){var a=function(a,c){this[a]||Object.defineProperty(this,a,{enumerable:!1,configurable:!1,writable:!1,value:this._crossfilter.dimension(function(a){return b.isNone(a[c])?"get"in a?a.get(c):null:a[c]})})};a.apply(this,["_dimensionDefault",b.get(this,"primaryKey")||"id"]);for(var c in this.filterMap)if(this.filterMap.hasOwnProperty(c)){this.filterMap[c].name=c,c=this.filterMap[c],c.value=null,b.set(c,"active",!1),this.isBooleanFilter(c)&&(b.set(c,"active",[]),this._createFilterBoolean(c));var d="_dimension%@".fmt(c.dimension.capitalize());a.apply(this,[d,c.property])}},_createFilterBoolean:function(c){var d=(new a.Date).getTime(),e=this.mapProperty(c.property),f=[].concat.apply([],e).uniq(),g=c.property,h={},i=0,j=0;for(var k in f)if(f.hasOwnProperty(k)){var l=1<<j++;i^=l,h[f[k]]=l}c.property="__ecBitwise%@".fmt(c.name.capitalize()),c.value=0,c._totalBitwise=i,c._mapProperties=h;for(var m=b.get(this,"content"),n=0,o=b.get(this,"content.length");o>=n;n++){var p=m.objectAt(n);if(p){for(var q=b.get(p,g),r=0,s=0,t=q.length;t>=s;s++){var u=q[s];u&&(r^=c._mapProperties[u])}Object.defineProperty(p,c.property,{enumerable:!1,configurable:!0,writable:!1,value:r})}}this.allowDebugging&&b.debug("Properties: %@ millisecond(s)".fmt((new a.Date).getTime()-d))},_sortedContent:function(a,c,d){var e=crossfilter.quicksort.by(function(a){return b.isNone(a[c])?"get"in a?a.get(c):null:a[c]}),f=e(a,0,b.get(a,"length"));return d||(f=f.reverse()),f},_setFilterBoolean:function(a,b){return"and"===this.getBooleanType(a)?void b.filterFunction(function(b){if(0===a.value)return!0;var c=!0;return a.value.forEach(function(a){return 0===(b&a)?(c=!1,!1):void 0}),c}):void b.filterFunction(function(b){return 0===a.value?!0:a.value&b})},_setFilterFunction:function(a,c){var d,e=this;return a.value===!1?void c.filterAll():(d="_apply%@".fmt(a.name.capitalize()),b.assert("Crossfilter `filterFunction` expects a callback named `%@`.".fmt(d),!!b.canInvoke(this,d)),e=this,void c.filterFunction(function(a){return e[d].apply(e,[a])}))},_setFilterRangeMin:function(a,c){var d,e=a.name.replace("min","max");b.assert("You must specify define the `max` dimension for %@".fmt(a.name),!!this.filterMap[e]),d=this.filterMap[e].value,c.filterRange([a.value||-1/0,d||1/0])},_setFilterRangeMax:function(a,c){var d,e=a.name.replace("max","min");b.assert("You must specify define the `min` dimension for %@".fmt(a.name),!!this.filterMap[e]),d=this.filterMap[e].value,c.filterRange([d||-1/0,a.value||1/0])}})}(window,window.Ember);